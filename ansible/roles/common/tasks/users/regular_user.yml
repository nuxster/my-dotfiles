---
- name: Create users config directory
  ansible.builtin.file:
    path: "{{ [lookup('env','HOME'), '.config'] | path_join }}"
    state: directory
    owner: "{{ USERNAME }}"
    group: "{{ USERNAME }}"

- name: Add user to groups and set default shell
  become: true
  ansible.builtin.user:
    name: "{{ USERNAME }}"
    shell: "/usr/bin/{{ shell_package_name }}"
    groups: "{{ user_groups }}"
    append: true

- name: Copy shell config file to user home directory
  ansible.builtin.copy:
    src: "{{ shell_config }}"
    dest: "{{ [lookup('env','HOME'), shell_config] | path_join }}"
    owner: "{{ USERNAME }}"
    group: "{{ USERNAME }}"
    mode: '0600'

- name: Copy oh-my-zsh config files to user home directory
  ansible.posix.synchronize:
    src: "{{ oh_my_zsh_tmp }}"
    dest: "{{ lookup('env','HOME') }}"
    delete: yes
    rsync_opts:
      - "--exclude=.git"
      - "--chown={{ USERNAME }}:{{ USERNAME }}"

- name: Configure sudoers
  become: true
  community.general.sudoers:
    name: "{{ USERNAME }}"
    state: present
    user: "{{ USERNAME }}"
    runas: ALL
    commands: ALL

- name: Regular user configure ssh
  block:
    - name: Regular user configure ssh | Create ~/.ssh
      ansible.builtin.file:
        path: "{{ [lookup('env','HOME'), '.ssh'] | path_join }}"
        state: directory
        owner: "{{ USERNAME }}"
        group: "{{ USERNAME }}"
        mode: '0700'

    - name: Regular user configure ssh | Create user ssh configuration files
      ansible.builtin.file:
        path: "{{ [lookup('env','HOME'), '.ssh', item] | path_join }}"
        state: touch
        owner: "{{ USERNAME }}"
        group: "{{ USERNAME }}"
        mode: '0600'
      loop: "{{ ssh_configuration_files }}"
    
    - name: Regular user configure ssh | Configure user config_ssh
      ansible.builtin.lineinfile:
        path: "{{ [lookup('env','HOME'), '.ssh', 'config_ssh'] | path_join }}"
        line: "{{ item }}"
      loop: "{{ ssh_config_ssh_parameters }}"
